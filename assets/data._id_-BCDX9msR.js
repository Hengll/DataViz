import{Z as ba,u as va,b as ga,T as Sa,r as b,d as z,e as Va,o as ka,f as ha,g as l,w as o,k as A,t as m,V as c,U as f,j as s,h as L,ak as O,aq as W,p as J,am as Q,ar as Y,an as Z,ap as G,F as ya,Y as Da}from"./index-DZJqTOcC.js";import{c as wa,a as H,u as K,b as w}from"./index.esm-CAxhLf46.js";import{P as $a}from"./papaparse.min-uQ8WGFOU.js";import{M as Na,A as Aa,t as Ia,c as Ca,a as xa,S as Pa,_ as Ra}from"./BtnDataDelete-3OvcscrW.js";import{b as X}from"./route-block-B_A1xBdJ.js";import{V as Ea,a as v}from"./VRow-z6NbZb3D.js";import{V as Fa}from"./VSelect-CyDtJ2bK.js";import{V as Ma}from"./VContainer-D-5Ubu1y.js";import{V as aa}from"./VForm-DAc3K8LU.js";import{V as ea}from"./VTextarea-Bz6IHS0F.js";import"./VList-BJqnyUvu.js";import"./ssrBoot-CZUi8WVT.js";import"./VDivider-B_oviSi_.js";import"./VMenu-Bg9405L2.js";import"./VSelectionControl-BBAOfTNd.js";const Ta={class:"text-center"},Ua={__name:"data.[id]",setup(_a){var U,_;const r=ba(),ta=va(),{apiAuth:g}=Da(),{t:n}=ga(),i=Sa(),S=b([]),V=b(((_=(U=r.dashboard)==null?void 0:U.dataSet)==null?void 0:_._id)||""),k=b(!1),la=()=>{k.value=!0},I=()=>{k.value=!1,ra(),P.value.deleteFileRecord()},h=b(!1),oa=()=>{y.value.value=r.dashboard.dataSet.dataName,D.value.value=r.dashboard.dataSet.dataInfo,h.value=!0},C=()=>{h.value=!1,ia()},p=b([]),x=b([]),P=b(null),R=async()=>{try{const{data:e}=await g.get("/dataSet/names");S.value=e.result}catch(e){console.log(e)}};R();const E=wa({dataName:H().required(n("api.dataNameRequired")),dataInfo:H()}),{handleSubmit:sa,isSubmitting:F,resetForm:ra}=K({validationSchema:E}),$=w("dataName"),N=w("dataInfo"),da=sa(async e=>{var d;if((d=p.value[0])!=null&&d.error)return;if(p.value.length===0){i({text:n("api.dataRequired"),snackbarProps:{color:"red"}});return}const t=new FileReader;t.readAsText(p.value[0].file),t.onload=async function(){var j,B;let a;if(p.value[0].file.type==="text/csv")a=$a.parse(t.result,{header:!0,skipEmptyLines:!0}).data;else if(p.value[0].file.type==="application/json"){if(a=JSON.parse(t.result),!Array.isArray(a)){i({text:n("fileReader.array"),snackbarProps:{color:"red"}});return}for(const u of a){if(typeof u!="object"||u===null||Array.isArray(u)){i({text:n("fileReader.object"),snackbarProps:{color:"red"}});return}for(const q in u)if(typeof u[q]=="object"&&u[q]!==null){i({text:n("fileReader.nested"),snackbarProps:{color:"red"}});return}}}else return;try{await g.post("/dataSet",{dataName:e.dataName,dataInfo:e.dataInfo,data:a}),await R(),await M(S.value[S.value.length-1]._id),V.value=r.dashboard.dataSet._id,i({text:n("dataSet.uploadSuccess"),snackbarProps:{color:"green"}}),I()}catch(u){console.log(u),i({text:n("api."+((B=(j=u==null?void 0:u.response)==null?void 0:j.data)==null?void 0:B.message)||"unknownError"),snackbarProps:{color:"red"}})}},t.onerror=function(){i({text:n("fileReader.fail"),snackbarProps:{color:"red"}})}}),M=async e=>{var t,d;try{await g.patch(`/dashboard/${r.dashboard._id}`,{dataSet:e}),await r.getDashboardWithAPI(r.dashboard._id),i({text:n("linkData.linkDataSuccess"),snackbarProps:{color:"green"}})}catch(a){console.log(a),i({text:n("api."+((d=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:d.message)||"unknownError"),snackbarProps:{color:"red"}})}},{handleSubmit:na,isSubmitting:T,resetForm:ia}=K({validationSchema:E}),y=w("dataName"),D=w("dataInfo"),ua=na(async e=>{var t,d;try{await g.patch(`/dataSet/${r.dashboard.dataSet._id}`,{dataName:e.dataName,data:r.dashboard.dataSet.data,dataInfo:e.dataInfo}),r.dashboard.dataSet.dataName=e.dataName,r.dashboard.dataSet.dataInfo=e.dataInfo,i({text:n("linkData.editSuccess"),snackbarProps:{color:"green"}}),C()}catch(a){console.log(a),i({text:n("api."+((d=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:d.message)||"unknownError"),snackbarProps:{color:"red"}})}});Na.registerModules([Aa]);const ma=Ia.withPart(ta.theme==="lightTheme"?Ca:xa),ca=z(()=>{var e;return(e=r.dashboard.dataSet)!=null&&e.data?r.dashboard.dataSet.data:[]}),fa=z(()=>{var e,t;return(e=r.dashboard.dataSet)!=null&&e.data?[...Object.keys((t=r.dashboard.dataSet)==null?void 0:t.data[0]).map(d=>({field:d,editable:!0})),{headerName:"Actions",cellRenderer:Ra}]:[]}),pa=async()=>{var e,t;try{r.saveDataWithApi(),i({text:n("linkData.saveDataSuccess"),snackbarProps:{color:"green"}})}catch(d){console.log(d),i({text:n("api."+((t=(e=d==null?void 0:d.response)==null?void 0:e.data)==null?void 0:t.message)||"unknownError"),snackbarProps:{color:"red"}})}};return(e,t)=>{const d=Va("VueFileAgent");return ka(),ha(ya,null,[l(Ma,{fluid:""},{default:o(()=>[l(Ea,null,{default:o(()=>[l(v,{cols:"12"},{default:o(()=>[A("h1",Ta,m(e.$t("editor.linkData")),1)]),_:1}),l(v,{cols:"4"},{default:o(()=>[l(c,{"prepend-icon":"mdi-upload",onClick:la},{default:o(()=>[f(m(e.$t("linkData.new")),1)]),_:1})]),_:1}),l(v,{cols:"5"},{default:o(()=>[l(Fa,{modelValue:V.value,"onUpdate:modelValue":[t[0]||(t[0]=a=>V.value=a),t[1]||(t[1]=a=>M(V.value))],density:"compact",variant:"outlined",label:e.$t("linkData.linkDataSelect"),items:S.value,"item-title":"dataName","item-value":"_id"},null,8,["modelValue","label","items"])]),_:1}),l(v,{cols:"2",class:"ms-auto d-flex justify-end"},{default:o(()=>[l(c,{color:"primary",onClick:pa},{default:o(()=>[f(m(e.$t("linkData.save")),1)]),_:1})]),_:1}),l(v,{cols:"6"},{default:o(()=>{var a;return[l(c,{"prepend-icon":"mdi-plus",disabled:!((a=s(r).dashboard.dataSet)!=null&&a.data),onClick:s(r).insertRowData},{default:o(()=>[f(m(e.$t("linkData.newRow")),1)]),_:1},8,["disabled","onClick"])]}),_:1}),l(v,{cols:"6",class:"d-flex justify-end"},{default:o(()=>{var a;return[l(c,{"prepend-icon":"mdi-pencil",disabled:!((a=s(r).dashboard.dataSet)!=null&&a.data),onClick:oa},{default:o(()=>[f(m(e.$t("linkData.editDataInfo")),1)]),_:1},8,["disabled"])]}),_:1}),l(v,{cols:"12"},{default:o(()=>[l(s(Pa),{"suppress-drag-leave-hides-columns":!0,"row-data":ca.value,"column-defs":fa.value,style:{height:"600px"},pagination:!0,theme:s(ma),onCellValueChanged:t[2]||(t[2]=a=>s(r).editData(a.node.id*1,a.colDef.field,a.newValue))},null,8,["row-data","column-defs","theme"])]),_:1})]),_:1})]),_:1}),l(G,{modelValue:k.value,"onUpdate:modelValue":t[7]||(t[7]=a=>k.value=a),width:"600"},{default:o(()=>[l(aa,{disabled:s(F),onSubmit:L(s(da),["prevent"])},{default:o(()=>[l(O,null,{default:o(()=>[l(W,{class:"d-flex align-center"},{default:o(()=>[l(J,{icon:"mdi-upload",class:"me-1"}),A("span",null,m(e.$t("linkData.editDataInfo")),1)]),_:1}),l(Q,null,{default:o(()=>[l(Y,{modelValue:s($).value.value,"onUpdate:modelValue":t[3]||(t[3]=a=>s($).value.value=a),"error-messages":s($).errorMessage.value,label:e.$t("dataSet.dataName"),variant:"outlined"},null,8,["modelValue","error-messages","label"]),l(ea,{modelValue:s(N).value.value,"onUpdate:modelValue":t[4]||(t[4]=a=>s(N).value.value=a),"error-messages":s(N).errorMessage.value,label:e.$t("dataSet.dataInfo"),variant:"outlined"},null,8,["modelValue","error-messages","label"]),l(d,{ref_key:"fileAgent",ref:P,modelValue:p.value,"onUpdate:modelValue":t[5]||(t[5]=a=>p.value=a),"raw-model-value":x.value,"onUpdate:rawModelValue":t[6]||(t[6]=a=>x.value=a),accept:"application/json,text/csv",deletable:"","max-size":"3MB","help-text":e.$t("fileAgent.helpText"),"error-text":{type:e.$t("fileAgent.errorType"),size:e.$t("fileAgent.errorSize")}},null,8,["modelValue","raw-model-value","help-text","error-text"])]),_:1}),l(Z,null,{default:o(()=>[l(c,{onClick:I},{default:o(()=>[f(m(e.$t("dataSet.cancel")),1)]),_:1}),l(c,{variant:"flat",color:"primary",type:"submit",loading:s(F)},{default:o(()=>[f(m(e.$t("dataSet.upload")),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"]),l(G,{modelValue:h.value,"onUpdate:modelValue":t[10]||(t[10]=a=>h.value=a),width:"600"},{default:o(()=>[l(aa,{disabled:s(T),onSubmit:L(s(ua),["prevent"])},{default:o(()=>[l(O,null,{default:o(()=>[l(W,{class:"d-flex align-center"},{default:o(()=>[l(J,{icon:"mdi-pencil",class:"me-1"}),A("span",null,m(e.$t("linkData.editDataInfo")),1)]),_:1}),l(Q,null,{default:o(()=>[l(Y,{modelValue:s(y).value.value,"onUpdate:modelValue":t[8]||(t[8]=a=>s(y).value.value=a),"error-messages":s(y).errorMessage.value,label:e.$t("dataSet.dataName"),variant:"outlined"},null,8,["modelValue","error-messages","label"]),l(ea,{modelValue:s(D).value.value,"onUpdate:modelValue":t[9]||(t[9]=a=>s(D).value.value=a),"error-messages":s(D).errorMessage.value,label:e.$t("dataSet.dataInfo"),variant:"outlined"},null,8,["modelValue","error-messages","label"])]),_:1}),l(Z,null,{default:o(()=>[l(c,{onClick:C},{default:o(()=>[f(m(e.$t("dataSet.cancel")),1)]),_:1}),l(c,{variant:"flat",color:"primary",type:"submit",loading:s(T)},{default:o(()=>[f(m(e.$t("linkData.edit")),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64)}}};typeof X=="function"&&X(Ua);export{Ua as default};
