import{Z as ba,u as va,b as ga,T as Sa,r as b,d as q,e as Va,o as ka,f as ha,g as l,w as o,k as N,t as m,V as c,U as f,j as s,h as z,aj as L,ap as O,p as W,al as J,aq as Q,am as Y,ao as Z,F as ya,Y as Da}from"./index-DgiCD0nG.js";import{c as wa,a as G,u as H,b as y}from"./index.esm-CALT8gbd.js";import{P as $a}from"./papaparse.min-Bg1S3DeI.js";import{M as Na,A as Aa,t as Ia,c as Ca,a as xa,S as Pa,_ as Ra}from"./BtnDataDelete-yeAyv56w.js";import{b as K}from"./route-block-B_A1xBdJ.js";import{V as Ea,a as v}from"./VRow-BTitbmQ4.js";import{V as Fa}from"./VSelect-XiQtFLcm.js";import{V as Ma}from"./VContainer-qKgdq2MU.js";import{V as X}from"./VForm-DxuSdm-E.js";import{V as aa}from"./VTextarea-Ccxul4Yv.js";import"./VList-GDRvtvQm.js";import"./ssrBoot-BMhA3bp9.js";import"./VDivider-C2HJDsnd.js";import"./VMenu-0v_Y2jvd.js";import"./VSelectionControl-BK60ZxOG.js";const Ta={class:"text-center"},Ua={__name:"data.[id]",setup(ja){var T,U;const r=ba(),ea=va(),{apiAuth:g}=Da(),{t:n}=ga(),i=Sa(),A=b([]),D=b(((U=(T=r.dashboard)==null?void 0:T.dataSet)==null?void 0:U.dataName)||""),S=b(!1),ta=()=>{S.value=!0},I=()=>{S.value=!1,sa(),P.value.deleteFileRecord()},V=b(!1),la=()=>{k.value.value=r.dashboard.dataSet.dataName,h.value.value=r.dashboard.dataSet.dataInfo,V.value=!0},C=()=>{V.value=!1,ia()},p=b([]),x=b([]),P=b(null),R=async()=>{try{const{data:e}=await g.get("/dataSet/names");A.value=e.result}catch(e){console.log(e)}};R();const E=wa({dataName:G().required(n("api.dataNameRequired")),dataInfo:G()}),{handleSubmit:oa,isSubmitting:F,resetForm:sa}=H({validationSchema:E}),w=y("dataName"),$=y("dataInfo"),ra=oa(async e=>{var d;if((d=p.value[0])!=null&&d.error)return;if(p.value.length===0){i({text:n("api.dataRequired"),snackbarProps:{color:"red"}});return}const t=new FileReader;t.readAsText(p.value[0].file),t.onload=async function(){var j,_;let a;if(p.value[0].file.type==="text/csv")a=$a.parse(t.result,{header:!0,skipEmptyLines:!0}).data;else if(p.value[0].file.type==="application/json"){if(a=JSON.parse(t.result),!Array.isArray(a)){i({text:n("fileReader.array"),snackbarProps:{color:"red"}});return}for(const u of a){if(typeof u!="object"||u===null||Array.isArray(u)){i({text:n("fileReader.object"),snackbarProps:{color:"red"}});return}for(const B in u)if(typeof u[B]=="object"&&u[B]!==null){i({text:n("fileReader.nested"),snackbarProps:{color:"red"}});return}}}else return;try{await g.post("/dataSet",{dataName:e.dataName,dataInfo:e.dataInfo,data:a}),R(),i({text:n("dataSet.uploadSuccess"),snackbarProps:{color:"green"}}),I()}catch(u){console.log(u),i({text:n("api."+((_=(j=u==null?void 0:u.response)==null?void 0:j.data)==null?void 0:_.message)||"unknownError"),snackbarProps:{color:"red"}})}},t.onerror=function(){i({text:n("fileReader.fail"),snackbarProps:{color:"red"}})}}),da=async e=>{var t,d;try{await g.patch(`/dashboard/${r.dashboard._id}`,{dataSet:e}),await r.getDashboardWithAPI(r.dashboard._id),i({text:n("linkData.linkDataSuccess"),snackbarProps:{color:"green"}})}catch(a){console.log(a),i({text:n("api."+((d=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:d.message)||"unknownError"),snackbarProps:{color:"red"}})}},{handleSubmit:na,isSubmitting:M,resetForm:ia}=H({validationSchema:E}),k=y("dataName"),h=y("dataInfo"),ua=na(async e=>{var t,d;try{await g.patch(`/dataSet/${r.dashboard.dataSet._id}`,{dataName:e.dataName,data:r.dashboard.dataSet.data,dataInfo:e.dataInfo}),r.dashboard.dataSet.dataName=e.dataName,r.dashboard.dataSet.dataInfo=e.dataInfo,i({text:n("linkData.editSuccess"),snackbarProps:{color:"green"}}),C()}catch(a){console.log(a),i({text:n("api."+((d=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:d.message)||"unknownError"),snackbarProps:{color:"red"}})}});Na.registerModules([Aa]);const ma=Ia.withPart(ea.theme==="lightTheme"?Ca:xa),ca=q(()=>{var e;return(e=r.dashboard.dataSet)!=null&&e.data?r.dashboard.dataSet.data:[]}),fa=q(()=>{var e,t;return(e=r.dashboard.dataSet)!=null&&e.data?[...Object.keys((t=r.dashboard.dataSet)==null?void 0:t.data[0]).map(d=>({field:d,editable:!0})),{headerName:"Actions",cellRenderer:Ra}]:[]}),pa=async()=>{var e,t;try{r.saveDataWithApi(),i({text:n("linkData.saveDataSuccess"),snackbarProps:{color:"green"}})}catch(d){console.log(d),i({text:n("api."+((t=(e=d==null?void 0:d.response)==null?void 0:e.data)==null?void 0:t.message)||"unknownError"),snackbarProps:{color:"red"}})}};return(e,t)=>{const d=Va("VueFileAgent");return ka(),ha(ya,null,[l(Ma,{fluid:""},{default:o(()=>[l(Ea,null,{default:o(()=>[l(v,{cols:"12"},{default:o(()=>[N("h1",Ta,m(e.$t("editor.linkData")),1)]),_:1}),l(v,{cols:"4"},{default:o(()=>[l(c,{"prepend-icon":"mdi-upload",onClick:ta},{default:o(()=>[f(m(e.$t("linkData.new")),1)]),_:1})]),_:1}),l(v,{cols:"5"},{default:o(()=>[l(Fa,{modelValue:D.value,"onUpdate:modelValue":[t[0]||(t[0]=a=>D.value=a),t[1]||(t[1]=a=>da(D.value))],density:"compact",variant:"outlined",label:e.$t("linkData.linkDataSelect"),items:A.value,"item-title":"dataName","item-value":"_id"},null,8,["modelValue","label","items"])]),_:1}),l(v,{cols:"2",class:"ms-auto d-flex justify-end"},{default:o(()=>[l(c,{color:"primary",onClick:pa},{default:o(()=>[f(m(e.$t("linkData.save")),1)]),_:1})]),_:1}),l(v,{cols:"6"},{default:o(()=>{var a;return[l(c,{"prepend-icon":"mdi-plus",disabled:!((a=s(r).dashboard.dataSet)!=null&&a.data),onClick:s(r).insertRowData},{default:o(()=>[f(m(e.$t("linkData.newRow")),1)]),_:1},8,["disabled","onClick"])]}),_:1}),l(v,{cols:"6",class:"d-flex justify-end"},{default:o(()=>{var a;return[l(c,{"prepend-icon":"mdi-pencil",disabled:!((a=s(r).dashboard.dataSet)!=null&&a.data),onClick:la},{default:o(()=>[f(m(e.$t("linkData.editDataInfo")),1)]),_:1},8,["disabled"])]}),_:1}),l(v,{cols:"12"},{default:o(()=>[l(s(Pa),{"suppress-drag-leave-hides-columns":!0,"row-data":ca.value,"column-defs":fa.value,style:{height:"600px"},pagination:!0,theme:s(ma),onCellValueChanged:t[2]||(t[2]=a=>s(r).editData(a.node.id*1,a.colDef.field,a.newValue))},null,8,["row-data","column-defs","theme"])]),_:1})]),_:1})]),_:1}),l(Z,{modelValue:S.value,"onUpdate:modelValue":t[7]||(t[7]=a=>S.value=a),width:"600"},{default:o(()=>[l(X,{disabled:s(F),onSubmit:z(s(ra),["prevent"])},{default:o(()=>[l(L,null,{default:o(()=>[l(O,{class:"d-flex align-center"},{default:o(()=>[l(W,{icon:"mdi-upload",class:"me-1"}),N("span",null,m(e.$t("linkData.editDataInfo")),1)]),_:1}),l(J,null,{default:o(()=>[l(Q,{modelValue:s(w).value.value,"onUpdate:modelValue":t[3]||(t[3]=a=>s(w).value.value=a),"error-messages":s(w).errorMessage.value,label:e.$t("dataSet.dataName"),variant:"outlined"},null,8,["modelValue","error-messages","label"]),l(aa,{modelValue:s($).value.value,"onUpdate:modelValue":t[4]||(t[4]=a=>s($).value.value=a),"error-messages":s($).errorMessage.value,label:e.$t("dataSet.dataInfo"),variant:"outlined"},null,8,["modelValue","error-messages","label"]),l(d,{ref_key:"fileAgent",ref:P,modelValue:p.value,"onUpdate:modelValue":t[5]||(t[5]=a=>p.value=a),"raw-model-value":x.value,"onUpdate:rawModelValue":t[6]||(t[6]=a=>x.value=a),accept:"application/json,text/csv",deletable:"","max-size":"3MB","help-text":e.$t("fileAgent.helpText"),"error-text":{type:e.$t("fileAgent.errorType"),size:e.$t("fileAgent.errorSize")}},null,8,["modelValue","raw-model-value","help-text","error-text"])]),_:1}),l(Y,null,{default:o(()=>[l(c,{onClick:I},{default:o(()=>[f(m(e.$t("dataSet.cancel")),1)]),_:1}),l(c,{variant:"flat",color:"primary",type:"submit",loading:s(F)},{default:o(()=>[f(m(e.$t("dataSet.upload")),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"]),l(Z,{modelValue:V.value,"onUpdate:modelValue":t[10]||(t[10]=a=>V.value=a),width:"600"},{default:o(()=>[l(X,{disabled:s(M),onSubmit:z(s(ua),["prevent"])},{default:o(()=>[l(L,null,{default:o(()=>[l(O,{class:"d-flex align-center"},{default:o(()=>[l(W,{icon:"mdi-pencil",class:"me-1"}),N("span",null,m(e.$t("linkData.editDataInfo")),1)]),_:1}),l(J,null,{default:o(()=>[l(Q,{modelValue:s(k).value.value,"onUpdate:modelValue":t[8]||(t[8]=a=>s(k).value.value=a),"error-messages":s(k).errorMessage.value,label:e.$t("dataSet.dataName"),variant:"outlined"},null,8,["modelValue","error-messages","label"]),l(aa,{modelValue:s(h).value.value,"onUpdate:modelValue":t[9]||(t[9]=a=>s(h).value.value=a),"error-messages":s(h).errorMessage.value,label:e.$t("dataSet.dataInfo"),variant:"outlined"},null,8,["modelValue","error-messages","label"])]),_:1}),l(Y,null,{default:o(()=>[l(c,{onClick:C},{default:o(()=>[f(m(e.$t("dataSet.cancel")),1)]),_:1}),l(c,{variant:"flat",color:"primary",type:"submit",loading:s(M)},{default:o(()=>[f(m(e.$t("linkData.edit")),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64)}}};typeof K=="function"&&K(Ua);export{Ua as default};
